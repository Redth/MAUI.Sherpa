@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Platform.Services
@inject ICopilotService CopilotService
@inject OperationModalService OperationModalService
@inject ProcessModalService ProcessModalService
@implements IDisposable

@if (showModal)
{
    <div class="copilot-retry-overlay">
        <div class="copilot-retry-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2><i class="fas fa-robot"></i> Copilot Troubleshooting</h2>
                <button class="btn-close" @onclick="CloseIfNotBusy" disabled="@isBusy">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="copilot-status">
                    @if (!isConnected)
                    {
                        <div class="status-banner connecting">
                            <i class="fas fa-plug"></i>
                            <span>@statusText</span>
                        </div>
                    }
                    else if (isBusy)
                    {
                        <div class="status-banner working">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>@statusText</span>
                        </div>
                    }
                </div>
                <div class="copilot-output" @ref="outputRef">
                    @foreach (var line in outputLines)
                    {
                        <div class="output-line @line.Type">@line.Text</div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                @if (isBusy)
                {
                    <button class="btn btn-danger" @onclick="Abort">
                        <i class="fas fa-stop"></i> Abort
                    </button>
                }
                else
                {
                    <button class="btn btn-secondary" @onclick="Close">Close</button>
                }
            </div>
        </div>
    </div>
}

<style>
    .copilot-retry-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20000;
        backdrop-filter: blur(2px);
    }

    .copilot-retry-modal {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .modal-header h2 {
        font-size: 18px;
        color: #2d3748;
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
    }

    .modal-header h2 i {
        color: #6366f1;
    }

    .btn-close {
        background: none;
        border: none;
        color: #718096;
        cursor: pointer;
        font-size: 18px;
        padding: 4px;
    }

    .btn-close:hover { color: #2d3748; }
    .btn-close:disabled { opacity: 0.5; cursor: not-allowed; }

    .modal-body {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        padding: 16px 24px;
        min-height: 300px;
    }

    .copilot-status {
        margin-bottom: 12px;
    }

    .status-banner {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        border-radius: 6px;
        font-size: 14px;
    }

    .status-banner.connecting {
        background: #ebf4ff;
        color: #3c366b;
    }

    .status-banner.working {
        background: #f0fdf4;
        color: #166534;
    }

    .copilot-output {
        flex: 1;
        background: #1a202c;
        border-radius: 8px;
        padding: 16px;
        font-family: 'SF Mono', Menlo, Monaco, 'Courier New', monospace;
        font-size: 13px;
        overflow-y: auto;
        line-height: 1.5;
    }

    .output-line {
        color: #e2e8f0;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .output-line.assistant { color: #a5b4fc; }
    .output-line.tool { color: #fbbf24; }
    .output-line.error { color: #f87171; }
    .output-line.system { color: #9ca3af; font-style: italic; }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-secondary { background: #718096; color: white; }
    .btn-secondary:hover:not(:disabled) { background: #4a5568; }

    .btn-danger { background: #e53e3e; color: white; }
    .btn-danger:hover:not(:disabled) { background: #c53030; }
</style>

@code {
    private bool showModal = false;
    private bool isConnected = false;
    private bool isBusy = false;
    private string statusText = "";
    private List<OutputLine> outputLines = new();
    private ElementReference outputRef;

    private record OutputLine(string Text, string Type);

    protected override void OnInitialized()
    {
        // Subscribe to modal services
        OperationModalService.OnTryWithCopilotRequested += HandleOperationRetry;
        ProcessModalService.OnTryWithCopilotRequested += HandleProcessRetry;

        // Subscribe to Copilot events
        CopilotService.OnAssistantDelta += OnAssistantDelta;
        CopilotService.OnAssistantMessage += OnAssistantMessage;
        CopilotService.OnSessionIdle += OnSessionIdle;
        CopilotService.OnError += OnCopilotError;
        CopilotService.OnToolStart += OnToolStart;
        CopilotService.OnToolComplete += OnToolComplete;
    }

    public void Dispose()
    {
        OperationModalService.OnTryWithCopilotRequested -= HandleOperationRetry;
        ProcessModalService.OnTryWithCopilotRequested -= HandleProcessRetry;

        CopilotService.OnAssistantDelta -= OnAssistantDelta;
        CopilotService.OnAssistantMessage -= OnAssistantMessage;
        CopilotService.OnSessionIdle -= OnSessionIdle;
        CopilotService.OnError -= OnCopilotError;
        CopilotService.OnToolStart -= OnToolStart;
        CopilotService.OnToolComplete -= OnToolComplete;
    }

    private async Task HandleOperationRetry(string title, string description, IEnumerable<OperationLogEntry> logs)
    {
        var logText = string.Join("\n", logs.Select(l => $"[{l.Timestamp:HH:mm:ss}] [{l.Level}] {l.Message}"));
        
        var prompt = $@"I was trying to perform an operation that failed. Please investigate and help me fix it.

## Operation
**Title:** {title}
**Description:** {description}

## Activity Log
```
{logText}
```

## What I Need
1. Analyze why this operation failed
2. Suggest or implement alternative solutions
3. If you can fix the issue, please do so
4. If the fix requires commands, explain what they do before running them

Please help me resolve this issue.";

        await StartCopilotSession(prompt);
    }

    private async Task HandleProcessRetry(string title, string command, string output)
    {
        var prompt = $@"A command I ran failed. Please investigate and help me fix it.

## Command
**Title:** {title}
**Command:** `{command}`

## Output
```
{output}
```

## What I Need
1. Analyze why this command failed
2. Suggest or implement alternative solutions
3. If you can fix the issue, please do so
4. If the fix requires different commands, explain what they do before running them

Please help me resolve this issue.";

        await StartCopilotSession(prompt);
    }

    private async Task StartCopilotSession(string prompt)
    {
        showModal = true;
        outputLines.Clear();
        isConnected = false;
        isBusy = true;
        statusText = "Connecting to Copilot...";
        await InvokeAsync(StateHasChanged);

        try
        {
            if (!CopilotService.IsConnected)
            {
                AddOutput("Connecting to GitHub Copilot CLI...", "system");
                await CopilotService.ConnectAsync();
            }

            statusText = "Starting session...";
            AddOutput("Starting Copilot session...", "system");
            await InvokeAsync(StateHasChanged);

            await CopilotService.StartSessionAsync();
            isConnected = true;

            statusText = "Analyzing failure...";
            AddOutput("Sending analysis request...", "system");
            await InvokeAsync(StateHasChanged);

            await CopilotService.SendMessageAsync(prompt);
        }
        catch (Exception ex)
        {
            AddOutput($"Error: {ex.Message}", "error");
            isBusy = false;
            statusText = "Failed to connect";
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OnAssistantDelta(string delta)
    {
        if (string.IsNullOrEmpty(delta)) return;
        
        var lastLine = outputLines.LastOrDefault();
        if (lastLine?.Type == "assistant")
        {
            outputLines.RemoveAt(outputLines.Count - 1);
            outputLines.Add(new OutputLine(lastLine.Text + delta, "assistant"));
        }
        else
        {
            outputLines.Add(new OutputLine(delta, "assistant"));
        }
        InvokeAsync(StateHasChanged);
    }

    private void OnAssistantMessage(string message)
    {
        if (!string.IsNullOrEmpty(message))
        {
            if (outputLines.Count > 0 && outputLines[^1].Type == "assistant")
            {
                outputLines.RemoveAt(outputLines.Count - 1);
            }
            AddOutput(message, "assistant");
        }
        InvokeAsync(StateHasChanged);
    }

    private void OnSessionIdle()
    {
        isBusy = false;
        statusText = "Complete";
        AddOutput("\n--- Analysis complete ---", "system");
        InvokeAsync(StateHasChanged);
    }

    private void OnCopilotError(string error)
    {
        AddOutput($"Error: {error}", "error");
        isBusy = false;
        statusText = "Error occurred";
        InvokeAsync(StateHasChanged);
    }

    private void OnToolStart(string toolName, string args)
    {
        statusText = $"Running: {toolName}";
        AddOutput($"[Tool: {toolName}]", "tool");
        InvokeAsync(StateHasChanged);
    }

    private void OnToolComplete(string toolName, string result)
    {
        statusText = "Processing...";
        InvokeAsync(StateHasChanged);
    }

    private void AddOutput(string text, string type)
    {
        outputLines.Add(new OutputLine(text, type));
    }

    private async Task Abort()
    {
        try
        {
            AddOutput("Aborting...", "system");
            await CopilotService.AbortAsync();
            isBusy = false;
            statusText = "Aborted";
        }
        catch { }
    }

    private void CloseIfNotBusy()
    {
        if (!isBusy) Close();
    }

    private void Close()
    {
        if (isBusy) return;
        showModal = false;
    }
}
