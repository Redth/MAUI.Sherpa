@using Microsoft.AspNetCore.Components.Routing
@using MauiSherpa.Core.Interfaces
@inject IUpdateService UpdateService
@inject ILoggingService Logger
@implements IDisposable

<Router AppAssembly="@typeof(App).Assembly">
    <Found Context="routeData">
        <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
        <FocusOnNavigate RouteData="@routeData" Selector="h1" />
    </Found>
    <NotFound>
        <PageTitle>Not found</PageTitle>
        <LayoutView Layout="@typeof(MainLayout)">
            <p role="alert">Sorry, there's nothing at this address.</p>
        </LayoutView>
    </NotFound>
</Router>

<UpdateAvailableModal 
    @ref="_updateModal"
    UpdateResult="@_updateCheckResult" 
    IsVisible="@_showUpdateModal"
    OnAccept="@HandleUpdateAccept"
    OnDecline="@HandleUpdateDecline"
    OnAutoUpdate="@HandleAutoUpdate" />

@code {
    private UpdateCheckResult? _updateCheckResult;
    private bool _showUpdateModal;
    private CancellationTokenSource _cts = new();
    private UpdateAvailableModal? _updateModal;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _ = CheckForUpdatesWithDelayAsync();
    }

    private async Task CheckForUpdatesWithDelayAsync()
    {
        try
        {
            await Task.Delay(3000, _cts.Token);
            var result = await UpdateService.CheckForUpdateAsync(_cts.Token);

            if (result.UpdateAvailable && result.LatestRelease != null)
            {
                var isDismissed = UpdateService.DismissedVersion == result.LatestRelease.TagName;

                await InvokeAsync(() =>
                {
                    _updateCheckResult = result;
                    _showUpdateModal = !isDismissed;
                    StateHasChanged();
                });
            }
        }
        catch (OperationCanceledException) { }
        catch (Exception ex)
        {
            Logger.LogError("Failed to check for updates", ex);
        }
    }

    private async Task HandleUpdateAccept()
    {
        if (_updateCheckResult?.LatestRelease?.HtmlUrl is { Length: > 0 } url)
        {
            try
            {
                await Launcher.OpenAsync(new Uri(url));
            }
            catch (Exception ex)
            {
                Logger.LogError("Failed to open release URL", ex);
            }
        }

        _showUpdateModal = false;
        StateHasChanged();
    }

    private Task HandleUpdateDecline()
    {
        if (_updateCheckResult?.LatestRelease != null)
            UpdateService.DismissVersion(_updateCheckResult.LatestRelease.TagName);

        _showUpdateModal = false;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task HandleAutoUpdate()
    {
        if (_updateCheckResult?.LatestRelease == null) return;

        try
        {
            var progress = new Progress<(double Percent, string Message)>(update =>
            {
                _updateModal?.UpdateProgress(update.Percent, update.Message);
            });

            await UpdateService.DownloadAndApplyUpdateAsync(_updateCheckResult.LatestRelease, progress, _cts.Token);
        }
        catch (Exception ex)
        {
            Logger.LogError("Auto-update failed", ex);
            _showUpdateModal = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
    }
}
