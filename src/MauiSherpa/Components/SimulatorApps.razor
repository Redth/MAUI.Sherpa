@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Core.Requests.Apple
@using MauiSherpa.Services
@using Shiny.Mediator
@inject IMediator Mediator
@inject ISimulatorService SimulatorService
@inject IAlertService AlertService
@inject IDialogService DialogService
@inject IFileSystemService FileSystem
@inject OperationModalService OperationModal
@inject BlazorToastService ToastService

@if (isVisible)
{
    <div class="modal-overlay" @onclick="Close">
        <div class="apps-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2><i class="fas fa-th-large"></i> Installed Apps — @SimulatorName</h2>
                <button class="close-btn" @onclick="Close">×</button>
            </div>

            <div class="apps-toolbar">
                <input type="text" placeholder="Search apps..." @bind="searchQuery" @bind:event="oninput" class="search-input" />
                <div class="filter-group">
                    <select @bind="filterType">
                        <option value="">All Types</option>
                        <option value="User">User</option>
                        <option value="System">System</option>
                    </select>
                </div>
                <button class="btn btn-success btn-sm" @onclick="InstallApp" disabled="@isLoading">
                    <i class="fas fa-plus"></i> Install .app
                </button>
                <button class="btn btn-primary btn-sm" @onclick="() => LoadApps(forceRefresh: true)" disabled="@isLoading">
                    <i class="fas @(isLoading ? "fa-spinner fa-spin" : "fa-sync-alt")"></i>
                </button>
            </div>

            <div class="apps-list">
                @if (isLoading && apps.Count == 0)
                {
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i> Loading installed apps...
                    </div>
                }
                else if (!FilteredApps.Any())
                {
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <span>No apps found</span>
                    </div>
                }
                else
                {
                    @foreach (var app in FilteredApps)
                    {
                        var isUserApp = app.ApplicationType != "System";
                        <div class="app-row @(isUserApp ? "user-app" : "")">
                            <div class="app-icon">
                                <i class="fas @(isUserApp ? "fa-cube" : "fa-mobile-screen")"></i>
                            </div>
                            <div class="app-details">
                                <div class="app-name">@app.Name</div>
                                <div class="app-bundle-id">
                                    @app.BundleId
                                    <button class="btn-copy-inline" @onclick="@(() => CopyToClipboard(app.BundleId))" title="Copy Bundle ID">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                @if (!string.IsNullOrEmpty(app.Version))
                                {
                                    <span class="app-version">v@(app.Version)</span>
                                }
                            </div>
                            <div class="app-type-badge">
                                <span class="badge @(isUserApp ? "badge-user" : "badge-system")">@app.ApplicationType</span>
                            </div>
                            <div class="app-actions">
                                <button class="btn btn-sm btn-secondary" @onclick="@(() => LaunchApp(app))" title="Launch">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary" @onclick="@(() => TerminateApp(app))" title="Terminate">
                                    <i class="fas fa-stop"></i>
                                </button>
                                @if (!string.IsNullOrEmpty(app.DataContainerPath))
                                {
                                    <button class="btn btn-sm btn-secondary" @onclick="@(() => RevealContainer(app))" title="Reveal data container in Finder">
                                        <i class="fas fa-folder-open"></i>
                                    </button>
                                }
                                @if (isUserApp)
                                {
                                    <button class="btn btn-sm btn-danger" @onclick="@(() => UninstallApp(app))" title="Uninstall">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
}

<style>
    .apps-modal {
        background: var(--card-bg);
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
    }
    .modal-header h2 { margin: 0; font-size: 16px; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
    .modal-header h2 i { color: var(--accent-primary); }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); }

    .apps-toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
    }
    .search-input {
        flex: 1;
        padding: 6px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 13px;
        background: var(--card-bg);
        color: var(--text-primary);
    }
    .search-input:focus { outline: none; border-color: var(--accent-primary); }
    .filter-group select {
        padding: 6px 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 13px;
        background: var(--card-bg);
        color: var(--text-primary);
    }

    .apps-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px 0;
    }

    .app-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 20px;
        transition: background 0.1s;
    }
    .app-row:hover { background: var(--bg-tertiary); }
    .app-row.user-app { border-left: 3px solid var(--accent-primary); }

    .app-icon { font-size: 20px; color: var(--text-secondary); width: 28px; text-align: center; }
    .app-icon i { font-size: 18px; }
    .user-app .app-icon { color: var(--accent-primary); }

    .app-details { flex: 1; min-width: 0; }
    .app-name { font-weight: 600; font-size: 13px; color: var(--text-primary); }
    .app-bundle-id {
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 11px;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .app-version { font-size: 11px; color: var(--text-muted); }

    .btn-copy-inline {
        background: none; border: none; color: var(--text-secondary);
        cursor: pointer; padding: 1px 4px; font-size: 10px;
        border-radius: 3px; transition: all 0.15s;
    }
    .btn-copy-inline:hover { color: var(--accent-primary); background: var(--bg-tertiary); }

    .app-type-badge { flex-shrink: 0; }
    .badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; }
    .badge-user { background: var(--status-success-bg); color: var(--status-success-text); }
    .badge-system { background: var(--bg-tertiary); color: var(--text-secondary); }

    .app-actions { display: flex; gap: 4px; flex-shrink: 0; }

    .loading-state, .empty-state {
        text-align: center; padding: 40px 20px;
        color: var(--text-muted); font-size: 14px;
        display: flex; flex-direction: column; align-items: center; gap: 12px;
    }
    .empty-state i, .loading-state i { font-size: 32px; }

    .btn { padding: 6px 14px; border: none; border-radius: 5px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; transition: all 0.15s; }
    .btn i { font-size: 11px; }
    .btn-sm { padding: 4px 8px; font-size: 11px; }
    .btn-primary { background: var(--accent-primary); color: white; }
    .btn-success { background: var(--accent-success); color: white; }
    .btn-secondary { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); }
    .btn-danger { background: var(--accent-danger); color: white; }
    .btn:hover:not(:disabled) { filter: brightness(1.1); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
</style>

@code {
    private bool isVisible;
    private bool isLoading;
    private string simulatorUdid = "";
    private string searchQuery = "";
    private string filterType = "";
    private List<SimulatorApp> apps = new();

    [Parameter] public string SimulatorName { get; set; } = "";

    private IEnumerable<SimulatorApp> FilteredApps => apps
        .Where(a => string.IsNullOrEmpty(searchQuery) ||
                    a.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                    a.BundleId.Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
        .Where(a => string.IsNullOrEmpty(filterType) ||
                    a.ApplicationType.Equals(filterType, StringComparison.OrdinalIgnoreCase));

    public async Task Show(string udid, string name)
    {
        simulatorUdid = udid;
        SimulatorName = name;
        isVisible = true;
        searchQuery = "";
        filterType = "";
        StateHasChanged();
        await LoadApps(forceRefresh: false);
    }

    public void Close()
    {
        isVisible = false;
        StateHasChanged();
    }

    private async Task LoadApps(bool forceRefresh)
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            if (forceRefresh)
                await Mediator.FlushStores($"apple:simulator:apps:{simulatorUdid}");

            var (_, result) = await Mediator.Request(new GetSimulatorAppsRequest(simulatorUdid));
            apps = result?.ToList() ?? new();
        }
        catch (Exception ex)
        {
            await AlertService.ShowToastAsync($"Error loading apps: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LaunchApp(SimulatorApp app)
    {
        var success = await SimulatorService.LaunchAppAsync(simulatorUdid, app.BundleId);
        if (success)
            await AlertService.ShowToastAsync($"Launched {app.Name}");
        else
            await AlertService.ShowToastAsync($"Failed to launch {app.Name}");
    }

    private async Task TerminateApp(SimulatorApp app)
    {
        var success = await SimulatorService.TerminateAppAsync(simulatorUdid, app.BundleId);
        if (success)
            await AlertService.ShowToastAsync($"Terminated {app.Name}");
        else
            await AlertService.ShowToastAsync($"Failed to terminate {app.Name}");
    }

    private void RevealContainer(SimulatorApp app)
    {
        if (!string.IsNullOrEmpty(app.DataContainerPath))
            FileSystem.RevealInFileManager(app.DataContainerPath);
    }

    private async Task UninstallApp(SimulatorApp app)
    {
        var confirm = await AlertService.ShowConfirmAsync(
            "Uninstall App",
            $"Are you sure you want to uninstall '{app.Name}' ({app.BundleId})?");

        if (!confirm) return;

        var result = await OperationModal.RunAsync(
            "Uninstall App",
            $"Uninstalling {app.Name}...",
            async ctx =>
            {
                ctx.LogInfo($"Bundle ID: {app.BundleId}");
                ctx.SetStatus("Uninstalling...");

                var success = await SimulatorService.UninstallAppAsync(simulatorUdid, app.BundleId,
                    new Progress<string>(msg => { ctx.LogInfo(msg); ctx.SetStatus(msg); }));

                if (success) ctx.LogSuccess($"Uninstalled {app.Name}");
                return success;
            },
            canCancel: false);

        if (result.Success)
            await LoadApps(forceRefresh: true);
    }

    private async Task InstallApp()
    {
        var appPath = await DialogService.PickOpenFileAsync("Select .app bundle", new[] { "app" });
        if (string.IsNullOrEmpty(appPath)) return;

        var result = await OperationModal.RunAsync(
            "Install App",
            $"Installing {Path.GetFileName(appPath)}...",
            async ctx =>
            {
                ctx.LogInfo($"Path: {appPath}");
                ctx.SetStatus("Installing...");

                var success = await SimulatorService.InstallAppAsync(simulatorUdid, appPath,
                    new Progress<string>(msg => { ctx.LogInfo(msg); ctx.SetStatus(msg); }));

                if (success) ctx.LogSuccess("App installed successfully");
                return success;
            });

        if (result.Success)
            await LoadApps(forceRefresh: true);
    }

    private async Task CopyToClipboard(string text)
    {
        await DialogService.CopyToClipboardAsync(text);
        await AlertService.ShowToastAsync("Copied to clipboard");
    }
}
