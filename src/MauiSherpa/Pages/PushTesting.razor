@page "/push-testing"
@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Services
@inject IAppleIdentityService IdentityService
@inject IApnsPushService PushService
@inject IDialogService DialogService
@inject IPushProjectService ProjectService
@inject BlazorToastService ToastService
@inject ILoggingService Logger
@inject IToolbarService ToolbarService
@implements IDisposable

<h1><i class="fas fa-paper-plane"></i> Push Testing</h1>

<PushProjectBar @ref="projectBar"
    Platform="PushProjectPlatform.Apns"
    ActiveProject="activeProject"
    ActiveProjectChanged="OnActiveProjectChanged"
    OnSaveRequested="SaveProject"
    IsDirty="isDirty" />

<div class="push-layout">
    <div class="push-section">
        <div class="section-header"><i class="fas fa-key"></i> Authentication</div>
        <div class="section-body">
            <div class="form-group">
                <label>Auth Method</label>
                <select @bind="authMode" @bind:after="MarkDirty">
                    <option value="identity">Stored Apple Identity</option>
                    <option value="p8file">.p8 File from Filesystem</option>
                </select>
            </div>

            @if (authMode == "identity")
            {
                <div class="form-group">
                    <label>Apple Identity</label>
                    @if (identities.Count == 0)
                    {
                        <div class="empty-state">No Apple identities configured. Add one in Settings.</div>
                    }
                    else
                    {
                        <select @bind="selectedIdentityId" @bind:after="MarkDirty">
                            <option value="">-- Select Identity --</option>
                            @foreach (var identity in identities)
                            {
                                <option value="@identity.Id">@identity.Name (Key: @identity.KeyId)</option>
                            }
                        </select>
                    }
                </div>
                <div class="form-group">
                    <label>Team ID</label>
                    <input type="text" @bind="teamId" @bind:after="MarkDirty" placeholder="e.g. ABC1234DEF" />
                </div>
            }
            else
            {
                <div class="form-group">
                    <label>.p8 Key File</label>
                    <div class="file-picker">
                        <input type="text" value="@p8FilePath" readonly placeholder="No file selected" />
                        <button class="btn btn-secondary" @onclick="PickP8File">
                            <i class="fas fa-folder-open"></i> Browse
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Team ID</label>
                    <input type="text" @bind="teamId" @bind:after="MarkDirty" placeholder="e.g. ABC1234DEF" />
                </div>
                <div class="form-group">
                    <label>Key ID</label>
                    <input type="text" @bind="p8KeyId" @bind:after="MarkDirty" placeholder="e.g. ABCDE12345" />
                </div>
            }
        </div>
    </div>

    <div class="push-section">
        <div class="section-header"><i class="fas fa-sliders-h"></i> Push Configuration</div>
        <div class="section-body">
            <div class="form-row">
                <div class="form-group flex-1">
                    <label>Push Type</label>
                    <select @bind="pushType" @bind:after="MarkDirty">
                        <option value="alert">Alert</option>
                        <option value="background">Background</option>
                        <option value="voip">VoIP</option>
                        <option value="complication">Complication</option>
                        <option value="fileprovider">File Provider</option>
                        <option value="mdm">MDM</option>
                        <option value="liveactivity">Live Activity</option>
                        <option value="pushtotalk">Push to Talk</option>
                        <option value="location">Location</option>
                    </select>
                </div>
                <div class="form-group flex-1">
                    <label>Priority</label>
                    <select @bind="priority" @bind:after="MarkDirty">
                        <option value="5">Normal (5)</option>
                        <option value="10">Immediate (10)</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group flex-1">
                    <label>Collapse ID <span class="optional">(optional)</span></label>
                    <input type="text" @bind="collapseId" @bind:after="MarkDirty" placeholder="Collapse identifier" />
                </div>
                <div class="form-group flex-1">
                    <label>Notification ID <span class="optional">(optional)</span></label>
                    <input type="text" @bind="notificationId" @bind:after="MarkDirty" placeholder="UUID format" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group flex-1">
                    <label>Expiration <span class="optional">(seconds, optional)</span></label>
                    <input type="number" @bind="expirationSeconds" @bind:after="MarkDirty" placeholder="0 = immediate expiry" />
                </div>
                <div class="form-group flex-1">
                    <label>Environment</label>
                    <select @bind="useSandbox" @bind:after="MarkDirty">
                        <option value="true">Sandbox</option>
                        <option value="false">Production</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="push-section">
        <div class="section-header"><i class="fas fa-envelope"></i> Payload</div>
        <div class="section-body">
            <div class="form-row">
                <div class="form-group flex-1">
                    <label>Bundle ID</label>
                    <input type="text" @bind="bundleId" @bind:after="MarkDirty" placeholder="e.g. com.example.myapp" />
                </div>
                <div class="form-group flex-1">
                    <label>Device Token</label>
                    <input type="text" @bind="deviceToken" @bind:after="MarkDirty" placeholder="Hex device token" />
                </div>
            </div>
            <div class="form-group">
                <label>JSON Body</label>
                <textarea class="json-editor" @bind="jsonPayload" @bind:after="MarkDirty" rows="12" spellcheck="false"></textarea>
            </div>
        </div>
    </div>

    <div class="action-bar">
        <button class="btn btn-primary btn-lg" @onclick="SendPush" disabled="@(isSending || !IsValid)">
            <i class="fas @(isSending ? "fa-spinner fa-spin" : "fa-paper-plane")"></i>
            @(isSending ? "Sending..." : "Send Push Notification")
        </button>
    </div>

    @if (activeProject?.History.Count > 0)
    {
        <div class="push-section">
            <div class="section-header">
                <span><i class="fas fa-history"></i> Send History</span>
                <button class="btn-clear" @onclick="ClearHistory">
                    <i class="fas fa-eraser"></i> Clear
                </button>
            </div>
            <div class="section-body history-list">
                @foreach (var entry in activeProject.History)
                {
                    <div class="history-card @(entry.Success ? "success" : "error")">
                        <div class="history-status">
                            <i class="fas @(entry.Success ? "fa-check-circle text-success" : "fa-times-circle text-danger")"></i>
                            <span class="history-time">@entry.Timestamp.ToLocalTime().ToString("HH:mm:ss")</span>
                            @if (entry.StatusCode.HasValue)
                            {
                                <span class="badge @(entry.Success ? "badge-success" : "badge-danger")">@entry.StatusCode</span>
                            }
                        </div>
                        <div class="history-details">
                            @if (!string.IsNullOrEmpty(entry.Target))
                            {
                                <div class="history-target mono"><i class="fas fa-mobile-alt"></i> @entry.Target</div>
                            }
                            @if (entry.Success && !string.IsNullOrEmpty(entry.MessageId))
                            {
                                <div class="history-message-id mono">@entry.MessageId</div>
                            }
                            @if (!entry.Success && !string.IsNullOrEmpty(entry.ErrorReason))
                            {
                                <div class="history-error">@entry.ErrorReason</div>
                            }
                            @if (!entry.Success && !string.IsNullOrEmpty(entry.ErrorDescription))
                            {
                                <div class="history-error-detail">@entry.ErrorDescription</div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    h1 {
        margin-bottom: 1.25rem;
    }

    .push-layout {
        display: flex;
        flex-direction: column;
        gap: 16px;
        max-width: 800px;
        padding-bottom: 40px;
    }

    .push-section {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        overflow: hidden;
    }

    .section-header {
        padding: 12px 20px;
        font-weight: 600;
        font-size: 14px;
        color: var(--text-primary);
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
    }

    .section-body {
        padding: 16px 20px;
    }

    .form-group {
        margin-bottom: 12px;
    }

    .form-group:last-child {
        margin-bottom: 0;
    }

    .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .optional {
        font-weight: 400;
        color: var(--text-tertiary);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--input-border);
        border-radius: 6px;
        background: var(--input-bg);
        color: var(--text-primary);
        font-size: 14px;
        box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .form-row {
        display: flex;
        gap: 12px;
    }

    .flex-1 {
        flex: 1;
    }

    .file-picker {
        display: flex;
        gap: 8px;
    }

    .file-picker input {
        flex: 1;
    }

    .json-editor {
        font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
        font-size: 13px;
        line-height: 1.5;
        resize: vertical;
        min-height: 200px;
        tab-size: 2;
    }

    .action-bar {
        display: flex;
        justify-content: flex-end;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-primary {
        background-color: var(--accent-primary);
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background-color: var(--accent-primary-hover);
    }

    .btn-secondary {
        background-color: var(--bg-hover);
        color: var(--text-secondary);
    }

    .btn-lg {
        padding: 12px 28px;
        font-size: 15px;
        font-weight: 600;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .empty-state {
        color: var(--text-tertiary);
        font-size: 13px;
        padding: 8px 0;
    }

    .btn-clear {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 0.75rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }

    .btn-clear:hover {
        background: var(--bg-hover);
        color: var(--text-secondary);
    }

    /* History */
    .history-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .history-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        display: flex;
        gap: 0.75rem;
        align-items: flex-start;
    }

    .history-card.success {
        border-left: 3px solid var(--success-color, #48bb78);
    }

    .history-card.error {
        border-left: 3px solid var(--danger-color, #f56565);
    }

    .history-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .history-time {
        font-size: 0.75rem;
        color: var(--text-muted);
        font-family: 'SF Mono', monospace;
    }

    .history-details {
        flex: 1;
        min-width: 0;
    }

    .history-target {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }

    .history-message-id {
        font-size: 0.6875rem;
        color: var(--text-muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .history-error {
        font-size: 0.75rem;
        color: var(--danger-color, #f56565);
    }

    .history-error-detail {
        font-size: 0.6875rem;
        color: var(--text-muted);
        margin-top: 0.125rem;
        word-break: break-word;
    }

    .badge {
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-size: 0.6875rem;
        font-weight: 600;
    }

    .badge-success {
        background: rgba(72, 187, 120, 0.15);
        color: var(--success-color, #48bb78);
    }

    .badge-danger {
        background: rgba(245, 101, 101, 0.15);
        color: var(--danger-color, #f56565);
    }

    .text-success { color: var(--success-color, #48bb78); }
    .text-danger { color: var(--danger-color, #f56565); }
    .mono { font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace; }
</style>

@code {
    PushProjectBar? projectBar;
    List<AppleIdentity> identities = new();
    PushProject? activeProject;

    // Auth
    string authMode = "identity";
    string selectedIdentityId = "";
    string p8FilePath = "";
    string p8KeyId = "";
    string teamId = "";

    // Config
    string pushType = "alert";
    int priority = 5;
    string collapseId = "";
    string notificationId = "";
    int? expirationSeconds;
    bool useSandbox = true;

    // Payload
    string bundleId = "";
    string deviceToken = "";
    string jsonPayload = "{\n  \"aps\": {\n    \"alert\": {\n      \"title\": \"Test\",\n      \"body\": \"Hello from MauiSherpa!\"\n    },\n    \"sound\": \"default\"\n  }\n}";

    // State
    bool isSending;
    bool isDirty;

    bool IsValid
    {
        get
        {
            if (string.IsNullOrWhiteSpace(bundleId) || string.IsNullOrWhiteSpace(deviceToken) || string.IsNullOrWhiteSpace(jsonPayload))
                return false;

            if (authMode == "identity")
            {
                if (string.IsNullOrWhiteSpace(selectedIdentityId) || string.IsNullOrWhiteSpace(teamId))
                    return false;
            }
            else
            {
                if (string.IsNullOrWhiteSpace(p8FilePath) || string.IsNullOrWhiteSpace(teamId) || string.IsNullOrWhiteSpace(p8KeyId))
                    return false;
            }

            return true;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        ToolbarService.ClearItems();
        identities = (await IdentityService.GetIdentitiesAsync()).ToList();

        // Migrate legacy settings if needed
        var migrated = await ProjectService.MigrateFromLegacyAsync();

        // Load projects and select most recent (or create blank)
        var projects = await ProjectService.GetProjectsAsync(PushProjectPlatform.Apns);
        if (projects.Count > 0)
        {
            var selected = migrated ?? projects[0];
            LoadFromProject(selected);
        }
    }

    void LoadFromProject(PushProject project)
    {
        activeProject = project;
        var config = project.ApnsConfig ?? new ApnsPushProjectConfig();

        authMode = config.AuthMode ?? "identity";
        selectedIdentityId = config.SelectedIdentityId ?? "";
        p8FilePath = config.P8FilePath ?? "";
        p8KeyId = config.P8KeyId ?? "";
        teamId = config.TeamId ?? "";
        pushType = config.PushType;
        priority = config.Priority;
        collapseId = config.CollapseId ?? "";
        notificationId = config.NotificationId ?? "";
        expirationSeconds = config.ExpirationSeconds;
        bundleId = config.BundleId ?? "";
        deviceToken = config.DeviceToken ?? "";
        jsonPayload = config.JsonPayload;
        useSandbox = config.UseSandbox;
        isDirty = false;
    }

    void ResetToBlank()
    {
        activeProject = null;
        var defaults = new ApnsPushProjectConfig();
        authMode = defaults.AuthMode ?? "identity";
        selectedIdentityId = "";
        p8FilePath = "";
        p8KeyId = "";
        teamId = "";
        pushType = defaults.PushType;
        priority = defaults.Priority;
        collapseId = "";
        notificationId = "";
        expirationSeconds = null;
        bundleId = "";
        deviceToken = "";
        jsonPayload = defaults.JsonPayload;
        useSandbox = defaults.UseSandbox;
        isDirty = false;
    }

    async Task OnActiveProjectChanged(PushProject? project)
    {
        if (project != null)
            LoadFromProject(project);
        else
            ResetToBlank();

        await Task.CompletedTask;
        StateHasChanged();
    }

    void MarkDirty() => isDirty = true;

    ApnsPushProjectConfig BuildConfig() => new()
    {
        AuthMode = authMode,
        SelectedIdentityId = string.IsNullOrEmpty(selectedIdentityId) ? null : selectedIdentityId,
        P8FilePath = string.IsNullOrEmpty(p8FilePath) ? null : p8FilePath,
        P8KeyId = string.IsNullOrEmpty(p8KeyId) ? null : p8KeyId,
        TeamId = string.IsNullOrEmpty(teamId) ? null : teamId,
        PushType = pushType,
        Priority = priority,
        CollapseId = string.IsNullOrEmpty(collapseId) ? null : collapseId,
        NotificationId = string.IsNullOrEmpty(notificationId) ? null : notificationId,
        ExpirationSeconds = expirationSeconds,
        BundleId = string.IsNullOrEmpty(bundleId) ? null : bundleId,
        DeviceToken = string.IsNullOrEmpty(deviceToken) ? null : deviceToken,
        JsonPayload = jsonPayload,
        UseSandbox = useSandbox
    };

    async Task SaveProject()
    {
        try
        {
            var name = projectBar?.GetProjectName() ?? "Untitled";
            var description = projectBar?.GetProjectDescription();

            if (activeProject != null)
            {
                var updated = activeProject with
                {
                    Name = name,
                    Description = description,
                    ApnsConfig = BuildConfig()
                };
                await ProjectService.SaveProjectAsync(updated);
                activeProject = await ProjectService.GetProjectAsync(updated.Id);
            }
            else
            {
                var project = new PushProject
                {
                    Name = name,
                    Description = description,
                    Platform = PushProjectPlatform.Apns,
                    ApnsConfig = BuildConfig()
                };
                await ProjectService.SaveProjectAsync(project);
                activeProject = await ProjectService.GetProjectAsync(project.Id);
            }

            isDirty = false;
            ToastService.Show("Project saved.", ToastType.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to save push project: {ex.Message}", ex);
            ToastService.Show($"Save failed: {ex.Message}", ToastType.Error);
        }
    }

    async Task PickP8File()
    {
        var path = await DialogService.PickOpenFileAsync("Select .p8 Key File", new[] { ".p8" });
        if (!string.IsNullOrEmpty(path))
        {
            p8FilePath = path;
            MarkDirty();
        }
    }

    async Task SendPush()
    {
        if (!IsValid) return;

        isSending = true;
        StateHasChanged();

        try
        {
            string p8Key;
            string keyId;

            if (authMode == "identity")
            {
                var identity = identities.FirstOrDefault(i => i.Id == selectedIdentityId);
                if (identity == null)
                {
                    ToastService.Show("Selected identity not found.", ToastType.Error);
                    return;
                }

                if (string.IsNullOrEmpty(identity.P8KeyContent))
                {
                    ToastService.Show("Selected identity has no P8 key content.", ToastType.Error);
                    return;
                }

                p8Key = identity.P8KeyContent;
                keyId = identity.KeyId;
            }
            else
            {
                if (!File.Exists(p8FilePath))
                {
                    ToastService.Show("P8 file not found.", ToastType.Error);
                    return;
                }

                p8Key = await File.ReadAllTextAsync(p8FilePath);
                keyId = p8KeyId;
            }

            var request = new ApnsPushRequest(
                P8Key: p8Key,
                KeyId: keyId,
                TeamId: teamId,
                BundleId: bundleId,
                DeviceToken: deviceToken,
                JsonPayload: jsonPayload,
                PushType: pushType,
                Priority: priority,
                CollapseId: string.IsNullOrWhiteSpace(collapseId) ? null : collapseId,
                NotificationId: string.IsNullOrWhiteSpace(notificationId) ? null : notificationId,
                ExpirationSeconds: expirationSeconds,
                UseSandbox: useSandbox
            );

            var result = await PushService.SendPushAsync(request);

            // Record history
            if (activeProject != null)
            {
                var historyEntry = new PushSendHistoryEntry
                {
                    Timestamp = DateTime.UtcNow,
                    Success = result.Success,
                    StatusCode = result.StatusCode,
                    MessageId = result.ApnsId,
                    ErrorReason = result.ErrorReason,
                    ErrorDescription = result.ErrorDescription,
                    Target = TruncateToken(deviceToken)
                };
                await ProjectService.AddHistoryEntryAsync(activeProject.Id, historyEntry);
                activeProject = await ProjectService.GetProjectAsync(activeProject.Id);
            }

            if (result.Success)
                ToastService.Show("Push notification sent successfully!", ToastType.Success);
            else
                ToastService.Show($"Push failed: {result.ErrorReason ?? "Unknown error"}", ToastType.Error);
        }
        catch (Exception ex)
        {
            Logger.LogError($"Push send error: {ex.Message}", ex);
            ToastService.Show($"Error: {ex.Message}", ToastType.Error);
        }
        finally
        {
            isSending = false;
            StateHasChanged();
        }
    }

    async Task ClearHistory()
    {
        if (activeProject == null) return;
        await ProjectService.ClearHistoryAsync(activeProject.Id);
        activeProject = await ProjectService.GetProjectAsync(activeProject.Id);
        StateHasChanged();
    }

    static string TruncateToken(string token) =>
        token.Length > 24 ? $"{token[..12]}...{token[^8..]}" : token;

    public void Dispose()
    {
    }
}
