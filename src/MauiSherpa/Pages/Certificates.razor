@page "/certificates"
@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Core.Requests.Apple
@using MauiSherpa.Services
@using Shiny.Mediator
@inject IMediator Mediator
@inject IAppleConnectService AppleService
@inject IAppleIdentityStateService IdentityState
@inject IAlertService AlertService
@inject IDialogService DialogService
@inject OperationModalService OperationModal
@implements IDisposable

<h1><i class="fas fa-certificate"></i> Certificates</h1>

<AppleIdentityPicker />

@if (IdentityState.SelectedIdentity != null)
{
    <div class="toolbar">
        <button class="btn btn-primary" @onclick="@(() => RefreshData(forceRefresh: true))" disabled="@isLoading">
            <i class="fas fa-sync-alt"></i> @(isLoading ? "Loading..." : "Refresh")
        </button>
        <button class="btn btn-success" @onclick="ShowCreateDialog" disabled="@isLoading">
            <i class="fas fa-plus"></i> Create Certificate
        </button>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="search-box">
            <span class="search-icon"><i class="fas fa-search"></i></span>
            <input type="text" @bind="searchQuery" @bind:event="oninput" placeholder="Search certificates..." />
            @if (!string.IsNullOrEmpty(searchQuery))
            {
                <button class="clear-btn" @onclick="@(() => searchQuery = "")">×</button>
            }
        </div>
        <div class="filter-chips">
            <select @bind="filterType" class="filter-select">
                <option value="">All Types</option>
                <option value="DEVELOPMENT">Development</option>
                <option value="DISTRIBUTION">Distribution</option>
                <option value="DEVELOPER_ID">Developer ID</option>
            </select>
            <select @bind="filterPlatform" class="filter-select">
                <option value="">All Platforms</option>
                <option value="IOS">iOS</option>
                <option value="MAC">macOS</option>
            </select>
            <select @bind="filterStatus" class="filter-select">
                <option value="">All Status</option>
                <option value="valid">Valid</option>
                <option value="expiring">Expiring Soon</option>
                <option value="expired">Expired</option>
            </select>
        </div>
        @if (HasActiveFilters)
        {
            <button class="clear-filters-btn" @onclick="ClearFilters">Clear Filters</button>
        }
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-bar">@errorMessage</div>
    }

    <div class="results-info">
        Showing @FilteredCertificates.Count() of @certificates.Count certificates
    </div>

    <div class="cert-list">
        @if (isLoading && certificates.Count == 0)
        {
            <div class="loading-state">
                <div class="loading-spinner">
                    <i class="fas fa-certificate"></i>
                </div>
                <div class="loading-title">Loading Certificates</div>
                <div class="loading-description">Fetching certificates from App Store Connect...</div>
            </div>
        }
        else if (!FilteredCertificates.Any())
        {
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-lock"></i></div>
                <div class="empty-title">@(certificates.Count == 0 ? "No certificates found" : "No certificates match filters")</div>
                <div class="empty-description">@(certificates.Count == 0 ? "Click \"Create Certificate\" to generate a new signing certificate" : "Try adjusting your search or filters")</div>
            </div>
        }
        else
        {
            @foreach (var cert in FilteredCertificates)
            {
                var isExpired = cert.ExpirationDate < DateTime.UtcNow;
                var isExpiringSoon = !isExpired && cert.ExpirationDate < DateTime.UtcNow.AddDays(30);
                
                <div class="cert-card @(isExpired ? "expired" : isExpiringSoon ? "expiring" : "")">
                    <div class="cert-icon"><i class="fas fa-lock"></i></div>
                    <div class="cert-details">
                        <div class="cert-name">@cert.Name</div>
                        <div class="cert-serial">
                            Serial: @cert.SerialNumber
                            <button class="btn-copy" @onclick="@(() => CopyToClipboard(cert.SerialNumber))" title="Copy to clipboard">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="cert-badges">
                            <span class="badge badge-type">@FormatCertType(cert.CertificateType)</span>
                            @if (!string.IsNullOrEmpty(cert.Platform))
                            {
                                <span class="badge badge-platform">@cert.Platform</span>
                            }
                            @if (isExpired)
                            {
                                <span class="badge badge-expired">Expired</span>
                            }
                            else if (isExpiringSoon)
                            {
                                <span class="badge badge-expiring">Expiring Soon</span>
                            }
                            else
                            {
                                <span class="badge badge-valid">Valid</span>
                            }
                        </div>
                        <div class="cert-expiry">
                            Expires: @cert.ExpirationDate.ToString("MMM dd, yyyy")
                        </div>
                    </div>
                    <div class="cert-actions">
                        <button class="btn btn-danger btn-sm" @onclick="@(() => RevokeCertificate(cert))" 
                                disabled="@isLoading" title="Revoke certificate">
                            <i class="fas fa-ban"></i> Revoke
                        </button>
                    </div>
                </div>
            }
        }
    </div>
}

@if (showCreateDialog)
{
    <div class="modal-overlay">
        <div class="modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Create Certificate</h2>
                <button class="close-btn" @onclick="CloseCreateDialog">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Certificate Type</label>
                    <select @bind="newCertType" class="form-control">
                        <option value="IOS_DEVELOPMENT">iOS Development</option>
                        <option value="IOS_DISTRIBUTION">iOS Distribution</option>
                        <option value="MAC_APP_DEVELOPMENT">Mac Development</option>
                        <option value="MAC_APP_DISTRIBUTION">Mac App Distribution</option>
                        <option value="MAC_INSTALLER_DISTRIBUTION">Mac Installer Distribution</option>
                        <option value="DEVELOPER_ID_APPLICATION">Developer ID Application</option>
                        <option value="DEVELOPER_ID_KEXT">Developer ID Kernel Extension</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Common Name (optional)</label>
                    <input type="text" @bind="newCertCommonName" class="form-control" 
                           placeholder="@Environment.MachineName" />
                    <small class="form-hint">Defaults to your machine name if not specified</small>
                </div>
                <div class="form-group">
                    <label>PFX Passphrase (optional)</label>
                    <input type="password" @bind="newCertPassphrase" class="form-control" 
                           placeholder="Leave empty for no passphrase" />
                    <small class="form-hint">Password to protect the exported certificate file</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseCreateDialog" disabled="@isCreating">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" @onclick="CreateCertificate" disabled="@isCreating">
                    <i class="fas @(isCreating ? "fa-spinner fa-spin" : "fa-plus")"></i> @(isCreating ? "Creating..." : "Create")
                </button>
            </div>
        </div>
    </div>
}

<style>
    h1 { margin-bottom: 20px; font-size: 28px; color: var(--text-primary); }

    .toolbar { margin-bottom: 16px; display: flex; gap: 12px; }
    .error-bar { background: var(--status-error-bg); color: var(--status-error-text); padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; }

    /* Filter Section Styles */
    .filter-section {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
    }

    .search-box {
        position: relative;
        flex: 1;
        min-width: 200px;
    }

    .search-box input {
        width: 100%;
        padding: 10px 36px 10px 36px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .search-box input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        opacity: 0.5;
    }

    .clear-btn {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: var(--border-color);
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
    }

    .clear-btn:hover { background: var(--bg-hover); }

    .filter-chips {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .filter-select {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 13px;
        background: var(--card-bg);
        cursor: pointer;
        min-width: 120px;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--accent-primary);
    }

    .clear-filters-btn {
        padding: 8px 12px;
        background: none;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 13px;
        color: var(--text-muted);
        cursor: pointer;
    }

    .clear-filters-btn:hover {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
    }

    .results-info {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 12px;
    }

    .btn { 
        padding: 10px 20px; 
        border: none; 
        border-radius: 6px; 
        font-size: 14px; 
        cursor: pointer; 
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .btn i { font-size: 12px; }
    .btn-primary { background-color: var(--accent-primary); color: white; }
    .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); }
    .btn-success { background-color: var(--accent-success); color: white; }
    .btn-success:hover:not(:disabled) { background-color: var(--accent-success-hover); }
    .btn-secondary { background-color: var(--bg-hover); color: var(--text-secondary); }
    .btn-secondary:hover:not(:disabled) { background-color: var(--bg-tertiary); }
    .btn-danger { background-color: #f56565; color: white; }
    .btn-danger:hover:not(:disabled) { background-color: var(--accent-danger); }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .cert-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }

    .cert-card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        align-items: flex-start;
        gap: 16px;
        box-shadow: var(--card-shadow);
        border-left: 4px solid var(--accent-success);
    }

    .cert-card.expired { border-left-color: #f56565; opacity: 0.7; }
    .cert-card.expiring { border-left-color: var(--accent-warning); }

    .cert-icon { font-size: 36px; color: #6b46c1; }
    .cert-icon i { font-size: 28px; }
    .cert-details { flex: 1; }
    .cert-name { font-weight: 600; font-size: 16px; color: var(--text-primary); }
    .cert-serial { 
        font-family: monospace; 
        font-size: 12px; 
        color: var(--text-muted); 
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .cert-expiry { font-size: 13px; color: var(--text-muted); margin-top: 8px; }
    .cert-badges { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .cert-actions { display: flex; gap: 8px; align-items: center; }

    .btn-copy {
        background: none;
        border: none;
        color: #a0aec0;
        cursor: pointer;
        padding: 2px 6px;
        font-size: 12px;
        border-radius: 4px;
        transition: all 0.15s;
        flex-shrink: 0;
    }
    .btn-copy:hover {
        color: var(--accent-primary);
        background: var(--bg-hover);
    }

    .badge { padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .badge-type { background: #faf5ff; color: #6b46c1; }
    .badge-platform { background: #bee3f8; color: #2c5282; }
    .badge-valid { background: var(--status-success-bg); color: var(--status-success-text); }
    .badge-expiring { background: var(--status-warning-bg); color: var(--status-warning-text); }
    .badge-expired { background: var(--status-error-bg); color: var(--status-error-text); }

    .empty-state { background: var(--card-bg); border-radius: 8px; padding: 60px 40px; text-align: center; box-shadow: var(--card-shadow); }
    .empty-icon { font-size: 48px; margin-bottom: 16px; color: #a0aec0; }
    .empty-icon i { font-size: 48px; }
    .empty-title { font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
    .empty-description { color: var(--text-muted); font-size: 14px; }

    /* Modal styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal {
        background: var(--card-bg);
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header h2 { margin: 0; font-size: 20px; color: var(--text-primary); }

    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .modal-body { padding: 24px; }
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-tertiary);
        border-radius: 0 0 12px 12px;
    }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-secondary); }
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
    }
    .form-control:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15); }
    .form-hint { display: block; margin-top: 4px; font-size: 12px; color: var(--text-muted); }
</style>

@code {
    private List<AppleCertificate> certificates = new();
    private bool isLoading = false;
    private bool isCreating = false;
    private string errorMessage = "";
    
    // Filter state
    private string searchQuery = "";
    private string filterType = "";
    private string filterPlatform = "";
    private string filterStatus = "";
    
    // Create dialog state
    private bool showCreateDialog = false;
    private string newCertType = "IOS_DEVELOPMENT";
    private string newCertCommonName = "";
    private string newCertPassphrase = "";

    private bool HasActiveFilters => !string.IsNullOrEmpty(searchQuery) || 
                                      !string.IsNullOrEmpty(filterType) || 
                                      !string.IsNullOrEmpty(filterPlatform) ||
                                      !string.IsNullOrEmpty(filterStatus);

    private IEnumerable<AppleCertificate> FilteredCertificates => certificates
        .Where(c => string.IsNullOrEmpty(searchQuery) || 
                    c.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                    c.SerialNumber.Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
        .Where(c => string.IsNullOrEmpty(filterType) || (c.CertificateType?.Contains(filterType, StringComparison.OrdinalIgnoreCase) ?? false))
        .Where(c => string.IsNullOrEmpty(filterPlatform) || (c.Platform?.Contains(filterPlatform, StringComparison.OrdinalIgnoreCase) ?? false))
        .Where(c => string.IsNullOrEmpty(filterStatus) || GetCertStatus(c) == filterStatus)
        .OrderByDescending(c => c.ExpirationDate > DateTime.UtcNow) // Valid first
        .ThenBy(c => c.ExpirationDate);

    private string GetCertStatus(AppleCertificate cert)
    {
        if (cert.ExpirationDate < DateTime.UtcNow) return "expired";
        if (cert.ExpirationDate < DateTime.UtcNow.AddDays(30)) return "expiring";
        return "valid";
    }

    private void ClearFilters()
    {
        searchQuery = "";
        filterType = "";
        filterPlatform = "";
        filterStatus = "";
    }

    protected override async Task OnInitializedAsync()
    {
        IdentityState.OnSelectionChanged += OnIdentityChanged;
        if (IdentityState.SelectedIdentity != null)
            await RefreshData();
    }

    private void OnIdentityChanged()
    {
        InvokeAsync(async () =>
        {
            await RefreshData();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        IdentityState.OnSelectionChanged -= OnIdentityChanged;
    }

    private async Task RefreshData(bool forceRefresh = false)
    {
        if (IdentityState.SelectedIdentity == null) return;

        isLoading = true;
        errorMessage = "";
        try
        {
            var request = new GetCertificatesRequest(IdentityState.SelectedIdentity.Id);
            var (_, result) = forceRefresh 
                ? await Mediator.Request(request, CancellationToken.None, ctx => ctx.ClearCache())
                : await Mediator.Request(request);
            certificates = result.ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load certificates: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ShowCreateDialog()
    {
        newCertType = "IOS_DEVELOPMENT";
        newCertCommonName = "";
        newCertPassphrase = "";
        showCreateDialog = true;
    }

    private void CloseCreateDialog()
    {
        showCreateDialog = false;
    }

    private async Task CreateCertificate()
    {
        showCreateDialog = false;
        
        var commonName = string.IsNullOrWhiteSpace(newCertCommonName) ? null : newCertCommonName;
        var passphrase = string.IsNullOrWhiteSpace(newCertPassphrase) ? null : newCertPassphrase;
        
        var result = await OperationModal.RunAsync(
            "Create Certificate",
            $"Creating {newCertType} certificate...",
            async ctx =>
            {
                ctx.SetStatus("Generating certificate signing request...");
                ctx.LogInfo($"Certificate type: {newCertType}");
                if (!string.IsNullOrEmpty(commonName))
                    ctx.LogInfo($"Common name: {commonName}");
                
                var certResult = await AppleService.CreateCertificateAsync(newCertType, commonName, passphrase);
                
                ctx.SetStatus("Saving certificate to Downloads...");
                var fileName = $"certificate_{newCertType}_{DateTime.Now:yyyyMMdd_HHmmss}.pfx";
                var downloadsPath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "Downloads", fileName);
                await File.WriteAllBytesAsync(downloadsPath, certResult.PfxData);
                
                ctx.LogSuccess($"Certificate saved: ~/Downloads/{fileName}");
                ctx.LogInfo($"Expires: {certResult.ExpirationDate:MMM dd, yyyy}");
                return true;
            },
            canCancel: false);

        if (result.Success)
        {
            await RefreshData(forceRefresh: true);
        }
    }

    private async Task RevokeCertificate(AppleCertificate cert)
    {
        var confirmed = await AlertService.ShowConfirmAsync(
            "Revoke Certificate",
            $"Are you sure you want to revoke '{cert.Name}'? This action cannot be undone and will invalidate any apps signed with this certificate.");
        
        if (!confirmed) return;

        var result = await OperationModal.RunAsync(
            "Revoke Certificate",
            $"Revoking '{cert.Name}'...",
            async ctx =>
            {
                ctx.SetStatus("Revoking certificate...");
                ctx.LogInfo($"Certificate: {cert.Name}");
                ctx.LogInfo($"Serial: {cert.SerialNumber}");
                
                await AppleService.RevokeCertificateAsync(cert.Id);
                ctx.LogSuccess("Certificate revoked successfully");
                return true;
            },
            canCancel: false);

        if (result.Success)
        {
            await RefreshData(forceRefresh: true);
        }
    }

    private string FormatCertType(string certType)
    {
        return certType.Replace("_", " ").ToLowerInvariant() switch
        {
            var t when t.Contains("development") => "Development",
            var t when t.Contains("distribution") => "Distribution",
            var t when t.Contains("push") => "Push Notification",
            _ => certType.Replace("_", " ")
        };
    }

    private async Task CopyToClipboard(string text)
    {
        await DialogService.CopyToClipboardAsync(text);
        await AlertService.ShowToastAsync("Copied to clipboard");
    }
}
