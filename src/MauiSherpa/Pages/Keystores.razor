@page "/keystores"
@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Core.Requests.Android
@using MauiSherpa.Services
@using Shiny.Mediator
@inject IMediator Mediator
@inject IKeystoreService KeystoreService
@inject IKeystoreSyncService SyncService
@inject ICloudSecretsService CloudSecretsService
@inject IOpenJdkSettingsService JdkSettings
@inject IAlertService AlertService
@inject IDialogService DialogService
@inject OperationModalService OperationModal
@inject MultiOperationModalService MultiOpModal
@inject BlazorToastService ToastService
@inject ILoggingService Logger
@inject ISecureStorageService SecureStorage
@inject IEncryptedSettingsService SettingsService
@implements IDisposable
@inject IJSRuntime JS
@inject IToolbarService ToolbarService
@inject IPreferences AppPreferences

<h1><i class="fas fa-key"></i> Keystores</h1>
<div class="toolbar">
    <button class="btn btn-primary" @onclick="@(() => RefreshData(true))" disabled="@isLoading">
        <i class="fas @(isLoading ? "fa-spinner fa-spin" : "fa-sync-alt")"></i> Refresh
    </button>
    <button class="btn btn-success" @onclick="ShowCreateDialog" disabled="@isLoading">
        <i class="fas fa-plus"></i> Create Keystore
    </button>
    <button class="btn btn-secondary" @onclick="ImportKeystore" disabled="@isLoading">
        <i class="fas fa-file-import"></i> Import
    </button>
    @if (CloudSecretsService.ActiveProvider != null)
    {
        <button class="btn btn-outline-primary" @onclick="SyncAllFromCloud" disabled="@(isLoading || !HasCloudOnlyKeystores)">
            <i class="fas fa-cloud-download-alt"></i> Install All from Cloud
        </button>
        <button class="btn btn-outline-primary" @onclick="SyncAllToCloud" disabled="@(isLoading || !HasLocalOnlyKeystores)">
            <i class="fas fa-cloud-upload-alt"></i> Upload All to Cloud
        </button>
    }
</div>

@* Cloud Sync Hint *@
@if (CloudSecretsService.ActiveProvider == null && !syncHintDismissed)
{
    <div class="alert alert-info alert-dismissible">
        <div class="alert-content">
            <i class="fas fa-cloud info-icon"></i>
            <div>
                <strong>Sync keystores across machines</strong>
                <p>Configure a cloud secrets provider in <a href="/settings">Settings</a> to securely sync your signing keystores and passwords across all your development machines.</p>
            </div>
        </div>
        <button type="button" class="btn-close" @onclick="DismissSyncHint" title="Dismiss">Ã—</button>
    </div>
}

@if (jdkPath == null && !isLoading)
{
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>OpenJDK not found.</strong> Keystore operations require <code>keytool</code> from a JDK installation.
        Please configure the JDK path in <a href="/settings">Settings</a>.
    </div>
}

@if (isLoading)
{
    <div class="loading-card"><i class="fas fa-spinner fa-spin"></i> Loading keystores...</div>
}
else if (keystores.Count == 0)
{
    <div class="empty-state">
        <i class="fas fa-key fa-3x"></i>
        <h3>No Keystores</h3>
        <p>Create a new keystore for signing your Android apps, or import an existing one.</p>
    </div>
}
else
{
    <div class="keystores-grid">
        @foreach (var ks in keystores)
        {
            var syncLocation = GetSyncLocation(ks.Id);
            <div class="keystore-card">
                <div class="keystore-header">
                    <div class="keystore-info">
                        <h3 class="keystore-alias">@ks.Alias</h3>
                        <span class="badge badge-type">@ks.KeystoreType</span>
                        @if (CloudSecretsService.ActiveProvider != null)
                        {
                            <span class="badge @GetSyncBadgeClass(syncLocation)" title="@GetSyncStatusTooltip(syncLocation)">
                                @GetSyncStatusIcon(syncLocation) @GetSyncStatusText(syncLocation)
                            </span>
                        }
                    </div>
                    <div class="keystore-actions">
                        <button class="btn btn-secondary btn-icon" title="View Signatures" @onclick="@(() => ShowSignatures(ks))">
                            <i class="fas fa-fingerprint"></i>
                        </button>
                        <button class="btn btn-secondary btn-icon" title="Export PEPK" @onclick="@(() => ShowPepkDialog(ks))">
                            <i class="fas fa-file-export"></i>
                        </button>
                        @if (CloudSecretsService.ActiveProvider != null)
                        {
                            <div class="sync-menu-wrapper">
                                <button class="btn btn-secondary btn-icon" @onclick="@(() => ToggleSyncMenu(ks.Id))" @onclick:stopPropagation="true" title="Sync">
                                    <i class="fas fa-cloud"></i>
                                </button>
                                @if (openSyncMenuId == ks.Id)
                                {
                                    <div class="sync-dropdown-menu">
                                        @if (syncLocation == "local" || syncLocation == "synced")
                                        {
                                            <button type="button" class="sync-dropdown-item" @onclick="@(() => HandleUploadClick(ks))">
                                                <i class="fas fa-cloud-upload-alt"></i> Upload to Cloud
                                            </button>
                                        }
                                        @if (syncLocation == "cloud" || syncLocation == "synced")
                                        {
                                            <button type="button" class="sync-dropdown-item danger" @onclick="@(() => DeleteFromCloud(ks.Id, ks.Alias))">
                                                <i class="fas fa-cloud"></i> Delete from Cloud
                                            </button>
                                        }
                                        @if (syncLocation == "none")
                                        {
                                            <div class="sync-dropdown-item disabled">
                                                <i class="fas fa-exclamation-circle"></i> No sync available
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        <button class="btn btn-danger btn-icon" title="Remove" @onclick="@(() => RemoveKeystore(ks))">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="keystore-details">
                    <div class="detail-row">
                        <span class="detail-label">Path</span>
                        <span class="detail-value mono"><span class="@(demoMode ? "demo-blur" : "")">@ks.FilePath</span></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Created</span>
                        <span class="detail-value">@ks.CreatedDate.ToString("yyyy-MM-dd")</span>
                    </div>
                </div>
            </div>
        }

        @* Cloud-only keystores *@
        @foreach (var cs in cloudOnlyStatuses)
        {
            <div class="keystore-card cloud-only">
                <div class="keystore-header">
                    <div class="keystore-info">
                        <h3 class="keystore-alias"><i class="fas fa-cloud"></i> @cs.Alias</h3>
                        <span class="badge badge-sync-cloud" title="Exists in cloud only â€” install locally to use">
                            ðŸŸ¡ Cloud
                        </span>
                    </div>
                    <div class="keystore-actions">
                        <button class="btn btn-primary btn-sm" @onclick="@(() => DownloadFromCloud(cs))">
                            <i class="fas fa-download"></i> Install Locally
                        </button>
                        <button class="btn btn-danger btn-icon" title="Delete from Cloud" @onclick="@(() => DeleteFromCloud(null, cs.Alias))">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="keystore-details">
                    <div class="detail-row">
                        <span class="detail-label">Source</span>
                        <span class="detail-value">Cloud Storage</span>
                    </div>
                </div>
            </div>
        }
    </div>
}

@* ===== Create Keystore Modal ===== *@
@if (showCreateDialog)
{
    <div class="modal-overlay" @onclick="CloseCreateDialog">
        <div class="modal" id="create-keystore-modal" role="dialog" aria-modal="true" aria-labelledby="create-keystore-title" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2 id="create-keystore-title"><i class="fas fa-plus-circle"></i> Create Keystore</h2>
                <button class="btn-close" @onclick="CloseCreateDialog"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Alias *</label>
                    <input type="text" @bind="newAlias" @bind:event="oninput" placeholder="my-app-key" />
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Keystore Password *</label>
                        <input type="password" @bind="newKeystorePassword" @bind:event="oninput" />
                    </div>
                    <div class="form-group">
                        <label>Key Password *</label>
                        <input type="password" @bind="newKeyPassword" @bind:event="oninput" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Common Name (CN)</label>
                        <input type="text" @bind="newCN" placeholder="Your Name" />
                    </div>
                    <div class="form-group">
                        <label>Organization (O)</label>
                        <input type="text" @bind="newOrg" placeholder="Company" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Org Unit (OU)</label>
                        <input type="text" @bind="newOU" placeholder="Development" />
                    </div>
                    <div class="form-group">
                        <label>Country (C)</label>
                        <input type="text" @bind="newCountry" placeholder="US" maxlength="2" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>City (L)</label>
                        <input type="text" @bind="newCity" />
                    </div>
                    <div class="form-group">
                        <label>State (ST)</label>
                        <input type="text" @bind="newState" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Validity (days)</label>
                        <input type="number" @bind="newValidity" />
                    </div>
                    <div class="form-group">
                        <label>Key Algorithm</label>
                        <select @bind="newKeyAlg">
                            <option value="RSA">RSA</option>
                            <option value="EC">EC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Key Size</label>
                        <select @bind="newKeySize">
                            <option value="2048">2048</option>
                            <option value="4096">4096</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseCreateDialog">Cancel</button>
                <button class="btn btn-primary" @onclick="CreateKeystore" disabled="@(!CanCreate)">
                    <i class="fas fa-plus"></i> Create
                </button>
            </div>
        </div>
    </div>
}

@* ===== Signatures Modal ===== *@
@if (showSignaturesDialog)
{
    <div class="modal-overlay" @onclick="CloseSignaturesDialog">
        <div class="modal modal-lg" id="signatures-modal" role="dialog" aria-modal="true" aria-labelledby="sig-title" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2 id="sig-title"><i class="fas fa-fingerprint"></i> Signatures â€” @sigAlias</h2>
                <button class="btn-close" @onclick="CloseSignaturesDialog"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                @if (sigLoading)
                {
                    <div class="loading-card"><i class="fas fa-spinner fa-spin"></i> Computing signatures...</div>
                }
                else if (sigError != null)
                {
                    <div class="alert alert-danger">@sigError</div>
                    <div class="form-group">
                        <label>Keystore Password</label>
                        <input type="password" @bind="sigPassword" @bind:event="oninput" />
                        <button class="btn btn-primary btn-sm mt-2" @onclick="RetrySignatures">Retry</button>
                    </div>
                }
                else if (signatures != null)
                {
                    <table class="sig-table">
                        <thead>
                            <tr>
                                <th>Format</th>
                                <th>Value</th>
                                <th>Used By</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (signatures.SHA1Hex != null)
                            {
                                <tr>
                                    <td><strong>SHA-1</strong> <span class="badge">Hex</span></td>
                                    <td class="mono text-selectable"><span class="mono-value">@signatures.SHA1Hex</span></td>
                                    <td><span class="service-tag google"><i class="fab fa-google-play"></i>Google Play</span> <span class="service-tag firebase"><i class="fas fa-fire"></i>Firebase</span></td>
                                    <td><button class="btn-copy" @onclick="@(() => CopyToClipboard(signatures.SHA1Hex))"><i class="fas fa-copy"></i></button></td>
                                </tr>
                            }
                            @if (signatures.SHA256Hex != null)
                            {
                                <tr>
                                    <td><strong>SHA-256</strong> <span class="badge">Hex</span></td>
                                    <td class="mono text-selectable"><span class="mono-value">@signatures.SHA256Hex</span></td>
                                    <td><span class="service-tag google"><i class="fab fa-google-play"></i>Google Play</span> <span class="service-tag firebase"><i class="fas fa-fire"></i>Firebase</span></td>
                                    <td><button class="btn-copy" @onclick="@(() => CopyToClipboard(signatures.SHA256Hex))"><i class="fas fa-copy"></i></button></td>
                                </tr>
                            }
                            @if (signatures.SHA1Base64 != null)
                            {
                                <tr>
                                    <td><strong>SHA-1</strong> <span class="badge">Base64</span></td>
                                    <td class="mono text-selectable"><span class="mono-value">@signatures.SHA1Base64</span></td>
                                    <td><span class="service-tag facebook"><i class="fab fa-facebook"></i>Facebook SDK</span></td>
                                    <td><button class="btn-copy" @onclick="@(() => CopyToClipboard(signatures.SHA1Base64))"><i class="fas fa-copy"></i></button></td>
                                </tr>
                            }
                            @if (signatures.SHA256Base64 != null)
                            {
                                <tr>
                                    <td><strong>SHA-256</strong> <span class="badge">Base64</span></td>
                                    <td class="mono text-selectable"><span class="mono-value">@signatures.SHA256Base64</span></td>
                                    <td><span class="service-tag"><i class="fas fa-plug"></i>Other</span></td>
                                    <td><button class="btn-copy" @onclick="@(() => CopyToClipboard(signatures.SHA256Base64))"><i class="fas fa-copy"></i></button></td>
                                </tr>
                            }
                            @if (signatures.MD5Hex != null)
                            {
                                <tr>
                                    <td><strong>MD5</strong> <span class="badge">Hex</span></td>
                                    <td class="mono text-selectable"><span class="mono-value">@signatures.MD5Hex</span></td>
                                    <td><span class="service-tag muted"><i class="fas fa-history"></i>Legacy</span></td>
                                    <td><button class="btn-copy" @onclick="@(() => CopyToClipboard(signatures.MD5Hex))"><i class="fas fa-copy"></i></button></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseSignaturesDialog">Close</button>
            </div>
        </div>
    </div>
}

@* ===== PEPK Export Modal ===== *@
@if (showPepkDialog)
{
    <div class="modal-overlay" @onclick="ClosePepkDialog">
        <div class="modal" id="pepk-modal" role="dialog" aria-modal="true" aria-labelledby="pepk-title" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2 id="pepk-title"><i class="fas fa-file-export"></i> Export PEPK â€” @pepkAlias</h2>
                <button class="btn-close" @onclick="ClosePepkDialog"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p class="help-text">Export your signing key for Google Play App Signing. Paste the encryption key from your Play Console.</p>
                <div class="form-group">
                    <label>Keystore Password *</label>
                    <input type="password" @bind="pepkKeystorePassword" @bind:event="oninput" />
                </div>
                <div class="form-group">
                    <label>Key Password *</label>
                    <input type="password" @bind="pepkKeyPassword" @bind:event="oninput" />
                </div>
                <div class="form-group">
                    <label>Google Encryption Key *</label>
                    <input type="text" @bind="pepkEncryptionKey" @bind:event="oninput" placeholder="Paste from Play Console" />
                    <small class="help-text">Found in Play Console â†’ App integrity â†’ App signing</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="ClosePepkDialog">Cancel</button>
                <button class="btn btn-primary" @onclick="ExportPepk" disabled="@(!CanExportPepk)">
                    <i class="fas fa-file-export"></i> Export
                </button>
            </div>
        </div>
    </div>
}

<style>
    h1 { margin-bottom: 20px; }
    .toolbar { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .empty-state { text-align: center; padding: 60px 40px; color: var(--text-muted); }
    .empty-state i { margin-bottom: 16px; opacity: 0.4; }
    .empty-state h3 { color: var(--text-primary); margin-bottom: 8px; }
    .loading-card { text-align: center; padding: 40px; color: var(--text-muted); }

    .keystores-grid { display: flex; flex-direction: column; gap: 12px; }
    .keystore-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 16px 20px;
        box-shadow: var(--card-shadow);
    }
    .keystore-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .keystore-info { display: flex; align-items: center; gap: 10px; }
    .keystore-alias { font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary); }
    .keystore-actions { display: flex; gap: 4px; align-items: center; }
    .keystore-details { display: flex; flex-direction: column; gap: 4px; }
    .detail-row { display: flex; gap: 8px; font-size: 13px; }
    .detail-label { color: var(--text-muted); min-width: 60px; }
    .detail-value { color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; }

    .badge { padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .badge-type { background: var(--status-info-bg); color: var(--status-info-text); }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .btn i { font-size: 12px; }
    .btn-icon {
        width: 32px; height: 32px; padding: 0;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 6px; font-size: 13px;
    }
    .btn-icon i { font-size: 13px; margin: 0; }
    .btn-primary { background-color: var(--accent-primary); color: white; }
    .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); }
    .btn-success { background-color: var(--accent-success); color: white; }
    .btn-success:hover:not(:disabled) { background-color: var(--accent-success-hover); }
    .btn-secondary { background-color: var(--bg-hover); color: var(--text-secondary); }
    .btn-secondary:hover:not(:disabled) { background-color: var(--bg-tertiary); }
    .btn-danger { background-color: #f56565; color: white; }
    .btn-danger:hover:not(:disabled) { background-color: var(--accent-danger); }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .form-row { display: flex; gap: 12px; }
    .form-row .form-group { flex: 1; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    .form-group input, .form-group select { width: 100%; padding: 8px 12px; border: 1px solid var(--input-border); border-radius: 6px; background: var(--input-bg); color: var(--text-primary); font-size: 14px; }
    .form-group small { color: var(--text-muted); font-size: 11px; }
    .mt-2 { margin-top: 8px; }

    .sig-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .sig-table th { text-align: left; padding: 6px 8px; border-bottom: 2px solid var(--border-color); color: var(--text-secondary); font-size: 12px; text-transform: uppercase; }
    .sig-table td { padding: 4px 8px; border-bottom: 1px solid var(--border-color); color: var(--text-primary); vertical-align: middle; }
    .sig-table td.mono { font-family: 'Consolas', 'Monaco', monospace; font-size: 11px; word-break: break-all; }
    .sig-table td.mono .mono-value { background: var(--bg-tertiary); border-radius: 4px; padding: 0 6px; display: inline-block; margin: 4px 0; line-height: 1.2; }


    .btn-copy { background: none; border: none; color: var(--accent-primary); cursor: pointer; padding: 4px 8px; border-radius: 4px; }
    .btn-copy:hover { background: var(--bg-tertiary); }

    .service-tag { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; margin-right: 4px; white-space: nowrap; }
    .service-tag i { margin-right: 3px; font-size: 9px; }
    .service-tag.google { background: #e8f5e9; color: #2e7d32; }
    .service-tag.firebase { background: #fff3e0; color: #e65100; }
    .service-tag.facebook { background: #e3f2fd; color: #1565c0; }
    .service-tag.muted { background: var(--bg-tertiary); color: var(--text-muted); }

    :global(.theme-dark) .service-tag.google { background: rgba(46, 125, 50, 0.2); color: #9ae6b4; }
    :global(.theme-dark) .service-tag.firebase { background: rgba(230, 81, 0, 0.2); color: #fbd38d; }
    :global(.theme-dark) .service-tag.facebook { background: rgba(21, 101, 192, 0.2); color: #90cdf4; }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal { background: var(--card-bg); border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
    .modal-lg { max-width: 1000px !important; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-color); }
    .modal-header h2 { margin: 0; font-size: 18px; color: var(--text-primary); }
    .modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }
    .btn-close { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-muted); }

    .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .alert-warning { background: var(--status-warning-bg); color: var(--status-warning-text); }
    .alert-danger { background: var(--status-error-bg); color: var(--status-error-text); }
    .alert-info { background: var(--status-info-bg, #ebf8ff); color: var(--status-info-text, #2c5282); border: 1px solid var(--border-color); }
    .alert-dismissible { display: flex; align-items: flex-start; justify-content: space-between; }
    .alert-content { display: flex; align-items: flex-start; gap: 12px; }
    .alert-content .info-icon { font-size: 20px; margin-top: 2px; }
    .alert-content p { margin: 4px 0 0; font-size: 13px; opacity: 0.85; }

    .btn-outline-primary { background: transparent; color: var(--accent-primary); border: 1px solid var(--accent-primary); }
    .btn-outline-primary:hover:not(:disabled) { background: var(--accent-primary); color: white; }
    .btn-outline-primary:disabled { opacity: 0.5; }

    /* Sync status badges */
    .badge-sync-both, .badge-sync-synced { background: var(--sync-synced-bg); color: var(--sync-synced-text); }
    .badge-sync-local { background: var(--sync-local-bg); color: var(--sync-local-text); }
    .badge-sync-cloud { background: var(--sync-cloud-bg); color: var(--sync-cloud-text); }
    .badge-sync-none { background: var(--sync-none-bg); color: var(--sync-none-text); }

    /* Sync dropdown menu */
    .sync-menu-wrapper { position: relative; }
    .sync-dropdown-menu {
        position: absolute; right: 0; top: 100%; margin-top: 4px;
        min-width: 180px; background: var(--card-bg);
        border: 1px solid var(--border-color); border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15); z-index: 100; padding: 4px 0;
    }
    .sync-dropdown-item {
        display: flex; align-items: center; gap: 8px;
        width: 100%; padding: 7px 14px;
        border: none; background: none;
        color: var(--text-primary); font-size: 13px;
        cursor: pointer; text-align: left;
        transition: background 0.1s;
    }
    .sync-dropdown-item:hover:not(.disabled) { background: var(--bg-tertiary); }
    .sync-dropdown-item.disabled { color: var(--text-muted); cursor: default; opacity: 0.5; }
    .sync-dropdown-item i { font-size: 12px; width: 14px; text-align: center; color: var(--text-secondary); }
    .sync-dropdown-item.danger { color: var(--accent-danger, #e53e3e); }
    .sync-dropdown-item.danger i { color: var(--accent-danger, #e53e3e); }

    /* Cloud-only keystore card */
    .keystore-card.cloud-only { border-style: dashed; opacity: 0.85; }
    .keystore-card.cloud-only .keystore-alias i { margin-right: 6px; color: var(--text-muted); }
</style>

@code {
    private List<AndroidKeystore> keystores = new();
    private bool isLoading;
    private bool demoMode = false;
    private string? jdkPath;

    // Sync state
    private Dictionary<string, KeystoreSyncStatus> syncStatuses = new();
    private List<KeystoreSyncStatus> cloudOnlyStatuses = new();
    private string? openSyncMenuId;
    private bool syncHintDismissed;
    private const string SyncHintDismissedKey = "KeystoresSyncHintDismissed";

    private bool HasCloudOnlyKeystores => cloudOnlyStatuses.Count > 0;
    private bool HasLocalOnlyKeystores => syncStatuses.Values.Any(s => s.HasLocal && !s.HasCloud);

    // Create dialog state
    private bool showCreateDialog;
    private string newAlias = "";
    private string newKeystorePassword = "";
    private string newKeyPassword = "";
    private string newCN = "";
    private string newOU = "";
    private string newOrg = "";
    private string newCity = "";
    private string newState = "";
    private string newCountry = "";
    private int newValidity = 10000;
    private string newKeyAlg = "RSA";
    private int newKeySize = 2048;

    // Signatures dialog state
    private bool showSignaturesDialog;
    private bool sigLoading;
    private string? sigError;
    private string sigAlias = "";
    private string sigPassword = "";
    private AndroidKeystore? sigKeystore;
    private KeystoreSignatureInfo? signatures;

    // PEPK dialog state
    private bool showPepkDialog;
    private string pepkAlias = "";
    private string pepkKeystorePassword = "";
    private string pepkKeyPassword = "";
    private string pepkEncryptionKey = "";
    private AndroidKeystore? pepkKeystore;

    private bool CanCreate => !string.IsNullOrWhiteSpace(newAlias)
        && newKeystorePassword.Length >= 6
        && newKeyPassword.Length >= 6;

    private bool CanExportPepk => !string.IsNullOrWhiteSpace(pepkKeystorePassword)
        && !string.IsNullOrWhiteSpace(pepkKeyPassword)
        && !string.IsNullOrWhiteSpace(pepkEncryptionKey);

    // Modal interop
    private DotNetObjectReference<Keystores>? _dotNetRef;
    private readonly HashSet<string> _activeModals = new();

    protected override async Task OnInitializedAsync()
    {
        try { var settings = await SettingsService.GetSettingsAsync(); demoMode = settings.Preferences.DemoMode; } catch { }
        _dotNetRef = DotNetObjectReference.Create(this);
        syncHintDismissed = AppPreferences.Get(SyncHintDismissedKey, false);
        CloudSecretsService.OnActiveProviderChanged += OnActiveProviderChanged;

        // Initialize cloud secrets service to load active provider
        if (CloudSecretsService is MauiSherpa.Core.Services.CloudSecretsService svc)
            await svc.InitializeAsync();

        await RefreshData(false);

        ToolbarService.SetItems(
            new ToolbarAction("refresh", "Refresh", "arrow.clockwise"),
            new ToolbarAction("create", "Create Keystore", "plus"),
            new ToolbarAction("import", "Import", "square.and.arrow.down")
        );
        ToolbarService.ToolbarItemClicked += OnToolbarItemClicked;
    }

    private async Task RefreshData(bool forceRefresh)
    {
        isLoading = true;
        StateHasChanged();
        try
        {
            var jdkResult = await Mediator.Request(new GetJdkPathRequest());
            jdkPath = jdkResult.Result;
            var klist = await KeystoreService.ListKeystoresAsync();
            keystores = klist.ToList();
            await LoadSyncStatuses();
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to load keystores: {ex.Message}", ex);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // --- Create ---
    private void ShowCreateDialog()
    {
        newAlias = "";
        newKeystorePassword = "";
        newKeyPassword = "";
        newCN = ""; newOU = ""; newOrg = ""; newCity = ""; newState = ""; newCountry = "";
        newValidity = 10000; newKeyAlg = "RSA"; newKeySize = 2048;
        showCreateDialog = true;
        _ = InitModalAsync("create-keystore-modal");
    }

    private void CloseCreateDialog() { showCreateDialog = false; _ = DisposeModalAsync("create-keystore-modal"); }

    private async Task CreateKeystore()
    {
        var savePath = await DialogService.PickSaveFileAsync("Save Keystore", $"{newAlias}.keystore", ".keystore");
        if (savePath == null) return;

        CloseCreateDialog();
        await OperationModal.RunAsync("Create Keystore", $"Creating keystore '{newAlias}'...", async (ctx) =>
        {
            ctx.LogInfo($"Alias: {newAlias}");
            ctx.LogInfo($"Path: {savePath}");
            await KeystoreService.CreateKeystoreAsync(
                savePath, newAlias, newKeyPassword, newKeystorePassword,
                newCN, newOU, newOrg, newCity, newState, newCountry,
                newValidity, newKeyAlg, newKeySize);
            ctx.LogInfo("Keystore created successfully!");
            return true;
        });

        await RefreshData(true);
        ToastService.ShowSuccess($"Keystore '{newAlias}' created!");
    }

    // --- Import ---
    private async Task ImportKeystore()
    {
        var path = await DialogService.PickOpenFileAsync("Select Keystore", new[] { ".jks", ".keystore", ".p12", ".pfx" });
        if (path == null) return;

        var alias = System.IO.Path.GetFileNameWithoutExtension(path);
        var keystore = new AndroidKeystore(
            Id: Guid.NewGuid().ToString(),
            Alias: alias,
            FilePath: path,
            KeystoreType: path.EndsWith(".jks") ? "JKS" : "PKCS12",
            CreatedDate: File.GetCreationTimeUtc(path));

        await KeystoreService.AddKeystoreAsync(keystore);
        await RefreshData(true);
        ToastService.ShowSuccess($"Keystore '{alias}' imported!");
    }

    // --- Signatures ---
    private async Task ShowSignatures(AndroidKeystore ks)
    {
        sigKeystore = ks;
        sigAlias = ks.Alias;
        sigError = null;
        signatures = null;
        showSignaturesDialog = true;
        _ = InitModalAsync("signatures-modal");

        // Try stored password first
        var storedPwd = await SecureStorage.GetAsync($"android_keystore_pwd_{ks.Id}");
        if (!string.IsNullOrEmpty(storedPwd))
        {
            sigPassword = storedPwd;
            await LoadSignatures(ks, storedPwd);
        }
        else
        {
            sigLoading = false;
            sigError = "Enter the keystore password to view signatures.";
            StateHasChanged();
        }
    }

    private async Task RetrySignatures()
    {
        if (sigKeystore != null && !string.IsNullOrEmpty(sigPassword))
            await LoadSignatures(sigKeystore, sigPassword);
    }

    private async Task LoadSignatures(AndroidKeystore ks, string password)
    {
        sigLoading = true;
        sigError = null;
        StateHasChanged();
        try
        {
            signatures = await KeystoreService.GetSignatureHashesAsync(ks.FilePath, ks.Alias, password);
        }
        catch (Exception ex)
        {
            sigError = ex.Message;
        }
        finally
        {
            sigLoading = false;
            StateHasChanged();
        }
    }

    private void CloseSignaturesDialog() { showSignaturesDialog = false; _ = DisposeModalAsync("signatures-modal"); }

    // --- PEPK ---
    private void ShowPepkDialog(AndroidKeystore ks)
    {
        pepkKeystore = ks;
        pepkAlias = ks.Alias;
        pepkKeystorePassword = "";
        pepkKeyPassword = "";
        pepkEncryptionKey = "";
        showPepkDialog = true;
        _ = InitModalAsync("pepk-modal");
    }

    private void ClosePepkDialog() { showPepkDialog = false; _ = DisposeModalAsync("pepk-modal"); }

    private async Task ExportPepk()
    {
        if (pepkKeystore == null) return;

        var savePath = await DialogService.PickSaveFileAsync("Save PEPK File", $"{pepkAlias}.pepk", ".pepk");
        if (savePath == null) return;

        ClosePepkDialog();
        await OperationModal.RunAsync("Export PEPK", $"Exporting PEPK for '{pepkAlias}'...", async (ctx) =>
        {
            ctx.LogInfo($"Keystore: {pepkKeystore.FilePath}");
            ctx.LogInfo($"Alias: {pepkAlias}");
            await KeystoreService.ExportPepkAsync(
                pepkKeystore.FilePath, pepkAlias,
                pepkKeystorePassword, pepkKeyPassword,
                pepkEncryptionKey, savePath);
            ctx.LogInfo($"PEPK exported to: {savePath}");
            return true;
        });

        ToastService.ShowSuccess("PEPK file exported!");
    }

    // --- Cloud Sync ---
    private async Task LoadSyncStatuses()
    {
        if (CloudSecretsService.ActiveProvider == null)
        {
            syncStatuses.Clear();
            cloudOnlyStatuses.Clear();
            return;
        }

        try
        {
            var statuses = await SyncService.GetKeystoreStatusesAsync();
            syncStatuses = statuses.Where(s => s.HasLocal).ToDictionary(s => s.LocalId ?? s.Alias, s => s);
            cloudOnlyStatuses = statuses.Where(s => s.HasCloud && !s.HasLocal).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to load sync statuses: {ex.Message}", ex);
            syncStatuses.Clear();
            cloudOnlyStatuses.Clear();
        }
    }

    private string GetSyncLocation(string keystoreId)
    {
        if (!syncStatuses.TryGetValue(keystoreId, out var status))
            return "none";
        if (status.HasLocal && status.HasCloud) return "synced";
        if (status.HasLocal) return "local";
        if (status.HasCloud) return "cloud";
        return "none";
    }

    private string GetSyncBadgeClass(string location) => location switch
    {
        "synced" => "badge-sync-synced",
        "local" => "badge-sync-local",
        "cloud" => "badge-sync-cloud",
        _ => "badge-sync-none"
    };

    private string GetSyncStatusIcon(string location) => location switch
    {
        "synced" => "ðŸŸ¢",
        "local" => "ðŸ”µ",
        "cloud" => "ðŸŸ¡",
        _ => "âš«"
    };

    private string GetSyncStatusText(string location) => location switch
    {
        "synced" => "Synced",
        "local" => "Local",
        "cloud" => "Cloud",
        _ => "Not synced"
    };

    private string GetSyncStatusTooltip(string location) => location switch
    {
        "synced" => "Keystore exists locally and in cloud storage",
        "local" => "Keystore exists locally only â€” can upload to cloud",
        "cloud" => "Keystore in cloud only â€” can install locally",
        _ => "Keystore not synced with cloud"
    };

    private void ToggleSyncMenu(string? id)
    {
        openSyncMenuId = openSyncMenuId == id ? null : id;
    }

    private void DismissSyncHint()
    {
        syncHintDismissed = true;
        AppPreferences.Set(SyncHintDismissedKey, true);
    }

    private void OnActiveProviderChanged()
    {
        InvokeAsync(async () =>
        {
            await LoadSyncStatuses();
            StateHasChanged();
        });
    }

    private async void HandleUploadClick(AndroidKeystore ks)
    {
        openSyncMenuId = null;
        try
        {
            await UploadToCloud(ks);
        }
        catch (Exception ex)
        {
            Logger.LogError($"HandleUploadClick error: {ex}");
            await AlertService.ShowAlertAsync("Error", $"Upload failed: {ex.Message}");
        }
    }

    private async Task UploadToCloud(AndroidKeystore ks)
    {
        var password = await SecureStorage.GetAsync($"android_keystore_pwd_{ks.Id}");
        if (string.IsNullOrEmpty(password))
        {
            await AlertService.ShowAlertAsync("Password Required", "No stored password found. Please re-import the keystore to store the password.");
            return;
        }

        await OperationModal.RunAsync("Upload Keystore", $"Uploading '{ks.Alias}' to cloud...", async (ctx) =>
        {
            ctx.SetProgress(0);
            ctx.LogInfo("Uploading keystore file...");
            ctx.SetStatus("Uploading keystore file...");
            await SyncService.UploadKeystoreFileAsync(ks.Id, ctx.CancellationToken);
            ctx.SetProgress(33);

            ctx.LogInfo("Uploading password...");
            ctx.SetStatus("Uploading password...");
            await SyncService.UploadKeystorePasswordAsync(ks.Id, password, ctx.CancellationToken);
            ctx.SetProgress(66);

            ctx.LogInfo("Uploading metadata...");
            ctx.SetStatus("Uploading metadata...");
            await SyncService.UploadKeystoreMetadataAsync(ks.Id, ctx.CancellationToken);
            ctx.SetProgress(100);

            ctx.LogInfo("Upload complete!");
            return true;
        });

        await LoadSyncStatuses();
        StateHasChanged();
        ToastService.ShowSuccess($"Keystore '{ks.Alias}' uploaded to cloud!");
    }

    private async Task DownloadFromCloud(KeystoreSyncStatus status)
    {
        await OperationModal.RunAsync("Install Keystore", $"Installing '{status.Alias}' from cloud...", async (ctx) =>
        {
            ctx.LogInfo($"Downloading keystore '{status.Alias}' from cloud storage...");
            await SyncService.DownloadKeystoreFromCloudAsync(status.CloudKey!, default);
            ctx.LogInfo("Keystore installed successfully!");
            return true;
        });

        await RefreshData(true);
        ToastService.ShowSuccess($"Keystore '{status.Alias}' installed from cloud!");
    }

    private async Task DeleteFromCloud(string? localId, string alias)
    {
        openSyncMenuId = null;

        var confirmed = await AlertService.ShowConfirmAsync(
            "Delete from Cloud",
            $"Are you sure you want to delete '{alias}' from cloud storage?\n\nThis will remove the keystore and password from your cloud secrets provider. This action cannot be undone.");

        if (!confirmed) return;

        try
        {
            var cloudKey = $"KEYSTORE_{alias}";
            await SyncService.DeleteKeystoreFromCloudAsync(cloudKey, default);
            await LoadSyncStatuses();
            StateHasChanged();
            ToastService.ShowSuccess($"Keystore '{alias}' deleted from cloud.");
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to delete from cloud: {ex}");
            await AlertService.ShowAlertAsync("Delete Failed", ex.Message);
        }
    }

    private async Task SyncAllFromCloud()
    {
        if (cloudOnlyStatuses.Count == 0)
        {
            ToastService.ShowInfo("No keystores to install from cloud.");
            return;
        }

        var operations = cloudOnlyStatuses.Select(cs => new OperationItem(
            Id: cs.Alias,
            Name: cs.Alias,
            Description: "Cloud keystore",
            Execute: async ctx =>
            {
                ctx.LogInfo($"Installing '{cs.Alias}' from cloud...");
                try
                {
                    await SyncService.DownloadKeystoreFromCloudAsync(cs.CloudKey!, default);
                    ctx.LogSuccess($"Installed '{cs.Alias}'");
                    return true;
                }
                catch (Exception ex)
                {
                    ctx.LogError($"Error: {ex.Message}");
                    return false;
                }
            },
            IsEnabled: true,
            CanDisable: true
        )).ToList();

        var result = await MultiOpModal.RunAsync(
            "Install Keystores from Cloud",
            $"The following {cloudOnlyStatuses.Count} keystore(s) will be installed locally. Uncheck any you want to skip.",
            operations);

        if (result.Completed > 0)
            await RefreshData(true);
    }

    private async Task SyncAllToCloud()
    {
        var localOnly = keystores
            .Where(ks => GetSyncLocation(ks.Id) == "local")
            .ToList();

        if (localOnly.Count == 0)
        {
            ToastService.ShowInfo("No keystores to upload to cloud.");
            return;
        }

        var operations = localOnly.Select(ks => new OperationItem(
            Id: ks.Id,
            Name: ks.Alias,
            Description: ks.FilePath,
            Execute: async ctx =>
            {
                ctx.LogInfo($"Uploading '{ks.Alias}' to cloud...");
                try
                {
                    var password = await SecureStorage.GetAsync($"android_keystore_pwd_{ks.Id}");
                    if (string.IsNullOrEmpty(password))
                    {
                        ctx.LogError($"No stored password for '{ks.Alias}' â€” skipping");
                        return false;
                    }
                    await SyncService.UploadKeystoreToCloudAsync(ks.Id, password, default);
                    ctx.LogSuccess($"Uploaded '{ks.Alias}'");
                    return true;
                }
                catch (Exception ex)
                {
                    ctx.LogError($"Error: {ex.Message}");
                    return false;
                }
            },
            IsEnabled: true,
            CanDisable: true
        )).ToList();

        var result = await MultiOpModal.RunAsync(
            "Upload Keystores to Cloud",
            $"The following {localOnly.Count} keystore(s) will be uploaded to cloud storage. Uncheck any you want to skip.",
            operations);

        if (result.Completed > 0)
        {
            await LoadSyncStatuses();
            StateHasChanged();
        }
    }

    // --- Remove ---
    private async Task RemoveKeystore(AndroidKeystore ks)
    {
        var confirmed = await AlertService.ShowConfirmAsync("Remove Keystore",
            $"Remove '{ks.Alias}' from tracking? The keystore file will NOT be deleted.");
        if (!confirmed) return;

        await KeystoreService.RemoveKeystoreAsync(ks.Id);
        await RefreshData(true);
        ToastService.ShowSuccess($"Keystore '{ks.Alias}' removed.");
    }

    // --- Clipboard ---
    private async Task CopyToClipboard(string value)
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", value);
        ToastService.ShowSuccess("Copied to clipboard!");
    }

    // --- Modal Interop ---
    [JSInvokable]
    public void OnEscapePressed(string modalId)
    {
        switch (modalId)
        {
            case "create-keystore-modal": CloseCreateDialog(); break;
            case "signatures-modal": CloseSignaturesDialog(); break;
            case "pepk-modal": ClosePepkDialog(); break;
        }
        StateHasChanged();
    }

    private async Task InitModalAsync(string modalId)
    {
        await Task.Yield();
        try
        {
            await JS.InvokeVoidAsync("modalInterop.initialize", modalId, _dotNetRef);
            _activeModals.Add(modalId);
        }
        catch { }
    }

    private async Task DisposeModalAsync(string modalId)
    {
        try
        {
            await JS.InvokeVoidAsync("modalInterop.dispose", modalId);
            _activeModals.Remove(modalId);
        }
        catch { }
    }

    public void Dispose()
    {
        ToolbarService.ToolbarItemClicked -= OnToolbarItemClicked;
        ToolbarService.ClearItems();
        CloudSecretsService.OnActiveProviderChanged -= OnActiveProviderChanged;
        foreach (var id in _activeModals)
            try { JS.InvokeVoidAsync("modalInterop.dispose", id); } catch { }
        _dotNetRef?.Dispose();
    }

    private void OnToolbarItemClicked(string actionId)
    {
        InvokeAsync(async () =>
        {
            switch (actionId)
            {
                case "refresh": await RefreshData(true); break;
                case "create": ShowCreateDialog(); break;
                case "import": await ImportKeystore(); break;
            }
            StateHasChanged();
        });
    }
}
