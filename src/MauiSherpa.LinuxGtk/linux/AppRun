#!/bin/bash
# AppRun â€” AppImage entry point for MAUI Sherpa
# This script is executed when the AppImage is run.
# It sets up desktop integration and launches the application.

HERE="$(dirname "$(readlink -f "${0}")")"
APPDIR="${HERE}"

# Install desktop integration (icon + .desktop file) on first run
# so GNOME/KDE show the correct icon in the dock and app launcher.
DESKTOP_FILE="codes.redth.mauisherpa.desktop"
DESKTOP_DIR="${HOME}/.local/share/applications"
ICON_DIR="${HOME}/.local/share/icons/hicolor/512x512/apps"

if [ ! -f "${DESKTOP_DIR}/${DESKTOP_FILE}" ] || \
   [ "${APPDIR}/${DESKTOP_FILE}" -nt "${DESKTOP_DIR}/${DESKTOP_FILE}" ]; then
    mkdir -p "${DESKTOP_DIR}" "${ICON_DIR}"
    cp "${APPDIR}/maui-sherpa.png" "${ICON_DIR}/maui-sherpa.png"

    # Write .desktop pointing to this AppImage (or fallback to generic command)
    APPIMAGE_PATH="${APPIMAGE:-maui-sherpa}"
    sed "s|Exec=maui-sherpa %U|Exec=${APPIMAGE_PATH} %U|g" \
        "${APPDIR}/${DESKTOP_FILE}" > "${DESKTOP_DIR}/${DESKTOP_FILE}"

    gtk-update-icon-cache "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
fi

export PATH="${APPDIR}/usr/bin:${PATH}"
export LD_LIBRARY_PATH="${APPDIR}/usr/bin:${LD_LIBRARY_PATH}"

exec "${APPDIR}/usr/bin/MauiSherpa.LinuxGtk" "$@"
